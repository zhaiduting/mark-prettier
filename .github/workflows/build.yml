name: Build Mark Prettier Plugin

on:
    push:
        tags:
            - '*'   # ä»»æ„ tag push éƒ½è§¦å‘

permissions:
    contents: write  # ğŸ‘ˆ åœ¨è¿™é‡Œæ·»åŠ æƒé™

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            # 1. Checkout ä»“åº“
            -   name: Checkout repository
                uses: actions/checkout@v5

            # 2. è®¾ç½® Node.js
            -   name: Setup Node.js
                uses: actions/setup-node@v3
                with:
                    node-version: 24

            # 3. å®‰è£…ä¾èµ–
            -   name: Install dependencies
                run: npm ci

            # 4. è·å– tag å¹¶è¡¥å…¨ç‰ˆæœ¬å·
            -   name: Get version from tag
                id: get_version
                run: |
                    TAG_NAME="${GITHUB_REF#refs/tags/}"
                    # å»æ‰å¼€å¤´ vï¼Œå¦‚æœå­˜åœ¨
                    VERSION="${TAG_NAME#v}"
                    
                    # åˆ†å‰²æˆæ•°ç»„
                    IFS='.' read -ra PARTS <<< "$VERSION"
                    
                    # è¡¥å…¨ä¸º x.y.z
                    if [ ${#PARTS[@]} -eq 1 ]; then
                      VERSION="${PARTS[0]}.0.0"
                    elif [ ${#PARTS[@]} -eq 2 ]; then
                      VERSION="${PARTS[0]}.${PARTS[1]}.0"
                    fi
                    
                    echo "version=$VERSION" >> $GITHUB_ENV
                    echo "Tag name: $TAG_NAME"
                    echo "Release version: $VERSION"

            # 5. æ›´æ–° manifest.json çš„ version
            -   name: Update manifest.json version
                run: |
                    jq --arg ver "${{ env.version }}" '.version = $ver' manifest.json > manifest.tmp.json
                    mv manifest.tmp.json manifest.json
                shell: bash

            # 6. æ„å»ºæ’ä»¶ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
            -   name: Build plugin
                run: npm run build

            # 7. ä¸Šä¼  artifactï¼ˆå¯ä¸‹è½½æµ‹è¯•ï¼‰ - ä¿ç•™è¿™ä¸ªæ­¥éª¤ï¼Œä»¥ä¾¿äºè°ƒè¯•
            -   name: Upload plugin artifact
                uses: actions/upload-artifact@v4
                with:
                    name: mark-prettier-plugin
                    path: |
                        main.js
                        manifest.json
                        styles.css
                        README.md

            # 8. åˆ›å»º Release å¹¶ä¸Šä¼ æ‰€æœ‰èµ„äº§ - åˆå¹¶ä¸ºä¸€æ­¥
            -   name: Create Release and Upload Assets
                uses: softprops/action-gh-release@v1
                with:
                    tag_name: ${{ github.ref_name }}
                    name: Mark Prettier Release ${{ env.version }}
                    body: "è‡ªåŠ¨æ‰“åŒ… Mark Prettier æ’ä»¶ (v${{ env.version }})"
                    draft: false # é»˜è®¤ä¸º falseï¼Œå¯ä»¥ä¸å†™
                    prerelease: false # é»˜è®¤ä¸º falseï¼Œå¯ä»¥ä¸å†™
                    files: |
                        main.js
                        manifest.json
                        styles.css
                        README.md
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
